name: Setup Android NDK bthread
on:
  push:
    branches:
      - main
jobs:
  ndk:
    name: ndk
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v4
        with:
          repository: sheldonrobinson/hdf5
      - name: bthread
        run: |
         ls $ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/
         git clone https://github.com/SomeDevHere/libbthread
         cd libbthread
         autoreconf -fvi
         export PATH="$PATH:$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/bi
         export target_host=aarch64-linux-android
         export AR=${target_host}-ar
         export AS=${target_host}-as
         export CC=${target_host}21-clang
         export CXX=${target_host}21-clang++
         export LD=${target_host}-ld
         export STRIP=${target_host}-strip
         export CFLAGS="-fPIE -fPIC"
         export LDFLAGS="-pie"
         ./configure --host=${target_host}
         make
         sudo make install
         cd ..
      - name: hdf5
        run: |
          dir /usr/local/lib/android/sdk/ndk/
          mkdir build
          cd build
          cmake \
          -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK/build/cmake/android.toolchain.cmake \
          -DANDROID:BOOL=TRUE \
          -DANDROID_ABI=arm64-v8a \
          -DBUILDNAME:STRING=pr4986/ndk27.0 \
          -DCTEST_DROP_SITE_INIT:STRING="my.cdash.org" \
          -DSITE:STRING=arm64-v8a \
          ..
          ctest -VV -T Build
