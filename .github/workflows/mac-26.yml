name: mac-26 ompi f j sz zl

on:
  workflow_dispatch:
  push:
    branches: [ main- ]

jobs:
  build:
    name: mac-26 ompi f j sz zl
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v4
        with:
          repository: HDFGroup/hdf5
      - name: install
        run: brew install libaec openmpi
      - name: test
        run: |
          export OMPI_MCA_rmaps_base_oversubscribe=1
          export OMPI_MCA_btl_vader_single_copy_mechanism=none
          export OMPI_MCA_mpi_yield_when_idle=1
          sudo ln -s /opt/homebrew/bin/gfortran-15 /opt/homebrew/bin/gfortran
          mkdir build
          cd build
          cmake \
          -DBUILDNAME:STRING=ompi/f/j/sz/zl \
          -DMPI_C_COMPILER=mpicc=mpicc \
          -DCMAKE_Fortran_COMPILER=mpifort \
          -DCTEST_DROP_SITE_INIT=my.cdash.org \
          -DHDF5_ALLOW_UNSUPPORTED=ON \
          -DHDF5_BUILD_FORTRAN=ON \
          -DHDF5_BUILD_JAVA=ON \
          -DHDF5_ENABLE_PARALLEL=ON \
          -DHDF5_ENABLE_SZIP_SUPPORT=ON \
          -DHDF5_ENABLE_ZLIB_SUPPORT=ON \
          -DMPI_C_COMPILER=mpicc \
          -DMPIEXEC_MAX_NUMPROCS=1 \
          -DMPIEXEC_PREFLAGS="--map-by :OVERSUBSCRIBE" \
          -DSITE:STRING=mac-26 \
          ..
          ctest -C Release -D Experimental
