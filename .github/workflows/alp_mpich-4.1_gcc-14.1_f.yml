name: alp mpich-4.1 gcc-14.1 f

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: checkout
        uses: actions/checkout@v5
        with:
          repository: HDFGroup/hdf5

      - name: alpine
        uses: jirutka/setup-alpine@v1
        with:
          arch: x86
          packages: >
            bison
            build-base
            cmake
            flex
            expat-dev
            gawk
            gfortran
            git
            gmp-dev
            mpfr-dev
            python3
            sudo
            texinfo
            wget
            zlib-dev
      - name: test
        run: |
          echo $HOME
          mkdir $HOME/.local
          git clone https://github.com/riscv-collab/riscv-gnu-toolchain
          cd riscv-gnu-toolchain
          ./configure  --with-arch=rv64gcv --with-abi=lp64d --with-languages=c,c++,fortran --prefix=$HOME/.local
          make -j2 musl
          make install
          cd ..
          wget https://www.mpich.org/static/downloads/4.1/mpich-4.1.tar.gz
          tar -xzf mpich-4.1.tar.gz
          cd mpich-4.1
          export PATH=$HOME/.local/bin:$PATH
          ./configure \
            --prefix=$HOME/.local \
            --host=riscv64-linux-musl \
             CC=riscv64-unknown-linux-musl-gcc \
             CXX=riscv64-unknown-linux-musl-g++ \
             FC=riscv64-unknown-linux-musl-gfortran \
             CROSS_F77_SIZEOF_INTEGER=4 \
             CROSS_F77_SIZEOF_REAL=4 \
             CROSS_F77_SIZEOF_DOUBLE_PRECISION=8 \
             CROSS_F90_ADDRESS_KIND=8 \
             CROSS_F90_OFFSET_KIND=8 \
             CROSS_F90_INTEGER_KIND=4 \
             CROSS_F90_REAL_MODEL=15,307 \
             CROSS_F90_DOUBLE_MODEL=15,307
          make -j2
          make install
          cd ..
          rm -rf mpich-4.1 mpich-4.1.tar.gz
          mkdir build
          cd build
          export CC=riscv64-unknown-linux-musl-gcc
          export CXX=riscv64-unknown-linux-musl-g++
          export FC=riscv64-unknown-linux-musl-gfortran
          export LD_LIBRARY_PATH=/home/runner/.local/lib:$LD_LIBRARY_PATH
          export MPI_C_COMPILER=/home/runner/.local/bin/mpicc
          export MPI_CXX_COMPILER=/home/runner/.local/bin/mpicxx
          export MPI_Fortran_COMPILER=/home/runner/.local/bin/mpifort
          export CROSS_F77_SIZEOF_INTEGER=4
          export CROSS_F77_SIZEOF_REAL=4
          export CROSS_F77_SIZEOF_DOUBLE_PRECISION=8
          export CROSS_F90_ADDRESS_KIND=8
          export CROSS_F90_OFFSET_KIND=8
          export CROSS_F90_INTEGER_KIND=4
          export CROSS_F90_REAL_MODEL=15,307
          export CROSS_F90_DOUBLE_MODEL=15,307
          export RISCV_ARCH_FLAGS="-march=rv64gc -mabi=lp64d"
          cmake \
            -DCMAKE_CROSSCOMPILING=TRUE \
            -DCMAKE_SYSTEM_PROCESSOR=riscv64 \
            -DBUILDNAME:STRING="x86_64.riscv/mpich-4.1/gcc-14.1/f" \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCTEST_DROP_SITE_INIT:STRING="my.cdash.org" \
            -DCTEST_DROP_LOCATION_INIT="/submit.php?project=HDF5" \
            -DHDF5_BUILD_FORTRAN=ON \
            -DHDF5_ENABLE_PARALLEL=ON \
            -DPAC_FC_ALL_INTEGER_KINDS_SIZEOF={1,2,4,8,16} -DPAC_FORTRAN_NUM_LOGICAL_KINDS=5 -DPAC_FC_ALL_LOGICAL_KINDS={1,2,4,8,16} -DPAC_FORTRAN_NUM_REAL_KINDS=3-DPAC_FC_ALL_REAL_KINDS={4,8,16} -DPAC_FC_ALL_REAL_KINDS_SIZEOF={4,8,16} -DH5_PAC_FC_MAX_REAL_PRECISION=33 -DPAC_FORTRAN_NATIVE_INTEGER_KIND=4 -DPAC_FORTRAN_NATIVE_INTEGER_SIZEOF=4 -DPAC_FORTRAN_NATIVE_REAL_KIND=4 -DPAC_FORTRAN_NATIVE_REAL_SIZEOF=4 -DPAC_FORTRAN_NATIVE_DOUBLE_KIND=8 -DPAC_FORTRAN_NATIVE_DOUBLE_SIZEOF=8 "-DH5_H5CONFIG_F_NUM_IKIND=INTEGER, PARAMETER :: num_ikinds = 5" "-DH5_H5CONFIG_F_IKIND=INTEGER, DIMENSION(1:num_ikinds) :: ikind = (/1,2,4,8,16/)" \
            -DSITE:STRING="alp" \
            ..
          ctest -C Debug -D Experimental
        shell: alpine.sh --root {0}
