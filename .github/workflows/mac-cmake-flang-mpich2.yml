name: mac14 flang

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    strategy:
      matrix:
        name: ["macOS Latest Clang"]
        include:
          - name: "macOS Latest Clang"
            artifact: "macOS.tar.xz"
            os: macos-13
            build_type: "Release"
            cpp: OFF
            fortran: ON
            java: ON
            ts: OFF
            hl: ON
            parallel: ON
            toolchain: "config/toolchain/clang.cmake"
            generator: "-G Ninja"

    name: ${{ matrix.name }}
    # The type of runner that the job will run on
    runs-on: ${{ matrix.os }}
    if: "!contains(github.event.head_commit.message, 'skip-ci')"

    steps:
    - name: Install Dependencies (macOS)
      run: brew install ninja
    - name: Install flang
      run : |
        git clone --quiet https://github.com/llvm/llvm-project.git
        mkdir build
        mkdir install
        ROOTDIR=`pwd`
        INSTALLDIR=$ROOTDIR/install
        echo $INSTALLDIR
        cd build
        cmake \
          -G Ninja \
          -DCMAKE_INSTALL_PREFIX=$INSTALLDIR \
           -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
          -DCMAKE_CXX_LINK_FLAGS="-Wl,-rpath,$LD_LIBRARY_PATH" \
          -DLLVM_TARGETS_TO_BUILD=host \
          -DLLVM_LIT_ARGS=-v \
          -DLLVM_ENABLE_PROJECTS="clang;flang" \
          -DLLVM_ENABLE_RUNTIMES="compiler-rt" \
          ../llvm-project/llvm
        ninja
        ninja install
